# ---------- STAGE 1: builder (uses Node + pnpm to build the app) ----------
FROM node:20-alpine AS builder

# Install pnpm so we can run pnpm commands inside the image
RUN npm install -g pnpm@10.17.1

# Set the working directory inside the image
WORKDIR /app

# Accept build arg for Vite environment
ARG VITE_API_URL
ENV VITE_API_URL=${VITE_API_URL}

# Copy only the necessary files to install dependencies
COPY package.json pnpm-lock.yaml* ./ 

# Install dependencies using pnpm
RUN pnpm install --frozen-lockfile

# Copy the rest of the application code to the working directory
COPY . .

# Build the application for production
RUN pnpm run build

# ---------- STAGE 2: runner (uses a lightweight web server to servethe built app) ----------
FROM nginx:alpine AS runner

# Optional: replace default nginx config to support SPA routing
COPY nginx.conf /etc/nginx/conf.d/default.conf


# Remove default static files (just in case)
RUN rm -rf /usr/share/nginx/html/*

# Copy the built static files from the builder stage into nginx's web root
COPY --from=builder /app/dist /usr/share/nginx/html

# Expose port 80 (the port nginx listens on inside the container)
EXPOSE 80

# Run nginx in the foreground so the container stays alive
CMD ["nginx", "-g", "daemon off;"]
